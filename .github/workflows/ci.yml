# .github/workflows/ci.yml
name: CI Pipeline

# 触发机制：当推送到 main 分支，或者提交 Pull Request 时触发
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # === 任务 1: 代码质量检查与测试 ===
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .  # 安装 pyproject.toml 里的依赖

      - name: Run Linter (Ruff)
        # 检查代码风格，如果很烂会直接报错
        run: |
          ruff check . 

      - name: Run Tests (Pytest)
        # 运行 tests/ 目录下的测试
        run: |
          pytest

  # === 任务 2: Docker 构建检查 ===
  docker-build-check:
    runs-on: ubuntu-latest
    needs: quality-check # 只有上面的检查通过了，才跑这一步
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build API Image
        # 尝试构建 API 镜像，确保 Dockerfile 没问题
        run: docker build -f api/Dockerfile -t my-platform-api:test .

      - name: Build Worker Image
        # 尝试构建 Worker 镜像
        run: docker build -f worker/Dockerfile -t my-platform-worker:test .